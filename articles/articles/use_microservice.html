<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Using a Microservice â€¢ Analytic Project Setup and Development</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../../bootstrap-toc.css">
<script src="../../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><meta property="og:title" content="Using a Microservice">
<meta property="og:description" content="usethis2">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">Analytic Project Setup and Development</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../../articles/articles/usethis2.html">Get started</a>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
<li>
  <a href="../../articles/index.html">Articles</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/tidylab/usethis2/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="use_microservice_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Using a Microservice</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/tidylab/usethis2/blob/master/vignettes/articles/use_microservice.Rmd"><code>vignettes/articles/use_microservice.Rmd</code></a></small>
      <div class="hidden name"><code>use_microservice.Rmd</code></div>

    </div>

    
    
<div id="what-does-use_microservice-do" class="section level2">
<h2 class="hasAnchor">
<a href="#what-does-use_microservice-do" class="anchor"></a>What does <code>use_microservice</code> do?</h2>
<p><strong>Given</strong> <code>entrypoint_name</code> (microservice), <code>endpoint_name</code> (RESTful), <code>host</code> (127.0.0.1) and <code>port</code> number (8080),</p>
<p><strong>When</strong> <code>use_microservice</code> is called</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../../reference/use_microservice.html">use_microservice</a></span><span class="op">(</span>
    entrypoint_name <span class="op">=</span> <span class="st">"microservice"</span>, 
    endpoint_name <span class="op">=</span> <span class="st">"RESTful"</span>,
    host <span class="op">=</span> <span class="st">"127.0.0.1"</span>,
    port <span class="op">=</span> <span class="fl">8080</span>             
<span class="op">)</span></code></pre></div>
<p><strong>Then</strong> the function generates the necessary files for a working-out-of-the-box microservice at <a href="http://127.0.0.1:8080/" class="uri">http://127.0.0.1:8080/</a>. In particular, the function creates or modifies the following files:</p>
<ul>
<li><p><code>./inst/entrypoints/microservice-foreground.R</code></p></li>
<li><p><code>./inst/entrypoints/microservice-background.R</code></p></li>
<li><p>.<code>/inst/endpoints/RESTful.R</code></p></li>
<li><p><code>./tests/testthat/test-endpoint-RESTful.R</code></p></li>
<li><p><code>./tests/testthat/helpers-xyz.R</code></p></li>
<li><p><code>./tests/testthat/setup-xyz.R</code></p></li>
<li><p><code>./DESCRIPTION</code></p></li>
</ul>
</div>
<div id="spinning-up-the-microservice" class="section level2">
<h2 class="hasAnchor">
<a href="#spinning-up-the-microservice" class="anchor"></a>Spinning up the Microservice</h2>
<p>Running the Microservice is done by one of two scripts:</p>
<ul>
<li><p><code>inst/entrypoints/microservice-foreground.R</code> runs the Microservice at the foreground. This option is appropriate during production. However, running the Microservice at this mode means the R session is locked and would not process CLI or other scripts commands until the Microservice is stopped.</p></li>
<li><p><code>inst/entrypoints/microservice-background.R</code>runs the Microservice at the</p></li>
</ul>
<p>background as an RStudio job. This option is appropriate during development. Running the Microservice at this mode allows the programmer to interact with the Microservice by sending it HTTP requests within the same R session.</p>
</div>
<div id="discovering-the-microservice-details" class="section level2">
<h2 class="hasAnchor">
<a href="#discovering-the-microservice-details" class="anchor"></a>Discovering the Microservice Details</h2>
<p>Communicating with the Microservice is done through HTTP requests. This means you need to know what URL exists, what service they provide, and what input they require.</p>
<p>Firstly, OpenAPI Specification provides visual documentation for the Microservice API. If the Microservice is hosted locally on port 8080, then you can browse OpenAPI at <a href="http://127.0.0.1:8080//__docs__/" class="uri">http://127.0.0.1:8080//__docs__/</a>.</p>
<p>Second source of documentation is the Microservice unit-test, located at <code>./tests/testthat/test-endpoint-RESTful.R</code>. The unit-test fully covers the available services, demonstrates how to send HTTP requests, and provides examples of how to post-process the returned response into an R <code>data.frame</code>.</p>
</div>
<div id="developing-and-testing-endpoints" class="section level2">
<h2 class="hasAnchor">
<a href="#developing-and-testing-endpoints" class="anchor"></a>Developing and Testing Endpoints</h2>
<p><code>use_microservice</code> automatically generates endpoint unit-test that is useful both for developing and testing the API. The boilerplate code of the unit-test looks like:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">context</span><span class="op">(</span><span class="st">"unit test for RESTful endpoint"</span><span class="op">)</span>

<span class="co"># Setup -------------------------------------------------------------------</span>
<span class="fu">testthat</span><span class="fu">::</span><span class="fu"><a href="https://testthat.r-lib.org/reference/teardown.html">setup</a></span><span class="op">(</span><span class="op">{</span>
    <span class="co">## Capture API Information</span>
    <span class="co"># httptest::.mockPaths(file.path(usethis::proj_get(), 'tests', 'api'))</span>
    <span class="co"># httptest::start_capturing()</span>
    <span class="co"># local_mock(with_mock_api = function(expr) eval(expr), .env = "httptest")</span>
    <span class="co"># GET &lt;&lt;- function(...) httptest::capture_requests(httr::GET(...))</span>
    <span class="co"># POST &lt;&lt;- function(...) httptest::capture_requests(httr::POST(...))</span>
<span class="op">}</span><span class="op">)</span>

<span class="co"># healthcheck -------------------------------------------------------------</span>
<span class="fu">httptest</span><span class="fu">::</span><span class="fu">with_mock_api</span><span class="op">(</span><span class="op">{</span>
    <span class="fu">test_that</span><span class="op">(</span><span class="st">"healthcheck returns a success"</span>, <span class="op">{</span>
        <span class="va">url</span> <span class="op">&lt;-</span> <span class="fu">generate_url</span><span class="op">(</span><span class="va">config</span><span class="op">$</span><span class="va">host</span>, <span class="va">config</span><span class="op">$</span><span class="va">port</span>, <span class="st">"utility/healthcheck"</span><span class="op">)</span>
        <span class="fu">expect_status_200</span><span class="op">(</span><span class="fu">GET</span><span class="op">(</span><span class="va">url</span><span class="op">)</span><span class="op">)</span>
    <span class="op">}</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>

<span class="co"># class -------------------------------------------------------------------</span>
<span class="fu">httptest</span><span class="fu">::</span><span class="fu">with_mock_api</span><span class="op">(</span><span class="op">{</span>
    <span class="fu">describe</span><span class="op">(</span><span class="st">"class"</span>, <span class="op">{</span>
        <span class="fu">it</span><span class="op">(</span><span class="st">"POST with character returns a character"</span>, <span class="op">{</span>
            <span class="va">input</span> <span class="op">&lt;-</span> <span class="st">"Hello World!"</span>
            <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html">toJSON</a></span><span class="op">(</span><span class="va">input</span>, auto_unbox <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
            <span class="va">url</span> <span class="op">&lt;-</span> <span class="fu">generate_url</span><span class="op">(</span><span class="va">config</span><span class="op">$</span><span class="va">host</span>, <span class="va">config</span><span class="op">$</span><span class="va">port</span>, <span class="st">"utility/class"</span><span class="op">)</span>
            <span class="fu">expect_status_200</span><span class="op">(</span><span class="va">response</span> <span class="op">&lt;-</span> <span class="fu">POST</span><span class="op">(</span><span class="va">url</span>, body <span class="op">=</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span>

            <span class="va">output</span> <span class="op">&lt;-</span>
                <span class="fu">extract_content_text</span><span class="op">(</span><span class="va">response</span><span class="op">)</span> <span class="op">%&gt;%</span>
                <span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html">fromJSON</a></span><span class="op">(</span>flatten <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span>
                <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove_all</a></span><span class="op">(</span><span class="st">'\"'</span><span class="op">)</span>
            <span class="fu">expect_match</span><span class="op">(</span><span class="va">output</span>, <span class="st">"character"</span><span class="op">)</span>
        <span class="op">}</span><span class="op">)</span>

        <span class="fu">it</span><span class="op">(</span><span class="st">"POST with data.frame returns a data.frame"</span>, <span class="op">{</span>
            <span class="va">input</span> <span class="op">&lt;-</span> <span class="va">mtcars</span>
            <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html">toJSON</a></span><span class="op">(</span><span class="va">input</span>, auto_unbox <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
            <span class="va">url</span> <span class="op">&lt;-</span> <span class="fu">generate_url</span><span class="op">(</span><span class="va">config</span><span class="op">$</span><span class="va">host</span>, <span class="va">config</span><span class="op">$</span><span class="va">port</span>, <span class="st">"utility/class"</span><span class="op">)</span>
            <span class="fu">expect_status_200</span><span class="op">(</span><span class="va">response</span> <span class="op">&lt;-</span> <span class="fu">POST</span><span class="op">(</span><span class="va">url</span>, body <span class="op">=</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span>

            <span class="va">output</span> <span class="op">&lt;-</span>
                <span class="fu">extract_content_text</span><span class="op">(</span><span class="va">response</span><span class="op">)</span> <span class="op">%&gt;%</span>
                <span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html">fromJSON</a></span><span class="op">(</span>flatten <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span>
                <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove_all</a></span><span class="op">(</span><span class="st">'\"'</span><span class="op">)</span>
            <span class="fu">expect_match</span><span class="op">(</span><span class="va">output</span>, <span class="st">"data.frame"</span><span class="op">)</span>
        <span class="op">}</span><span class="op">)</span>
    <span class="op">}</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>

<span class="co"># Teardown ----------------------------------------------------------------</span>
<span class="fu">testthat</span><span class="fu">::</span><span class="fu"><a href="https://testthat.r-lib.org/reference/teardown.html">teardown</a></span><span class="op">(</span><span class="op">{</span><span class="fu">httptest</span><span class="fu">::</span><span class="fu">stop_capturing</span><span class="op">(</span><span class="op">)</span><span class="op">}</span><span class="op">)</span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://github.com/harell">Harel Lustiger</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
